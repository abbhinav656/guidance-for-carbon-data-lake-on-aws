# This 3 stage ci pipeline is purpose-built for cdk

stages:          # List of stages for jobs, and their order of execution
  - build
  - static
  - validate
  - deploy

variables:
  PYTHON_SCRIPTS: bin/stats
  TS_SCRIPTS: bin/stats
  SHELL_SCRIPTS: bin/validate-config


build-job:       # Validates that cdk will build, install dependencies, and that cdk with synth
  stage: build
  image: docker
  services:
    - docker:dind
  script:
    - echo "installing node, npm, docker, aws-cli"
    - apk add --update nodejs npm
    - apk add --no-cache python3 py3-pip
    - apk add --update aws-cli
    - node --version
    - npm --version
    - python3 --version
    - pip3 --version
    - aws --version
    - echo "Logging into AWS Docker Public ECR to build lambda environment"
    - docker logout public.ecr.aws
    - echo "Installing typescript as dependency"
    - npm install typescript@latest -g
    - echo "succesfully installed typescript"
    - echo "Installing python as dependency"
    - echo "succesfully installed python"
    - echo "Installing all package dependencies"
    - npm install -g aws-cdk
    - npm ci
    - echo "succesfully installed package dependencies!"
    - echo "Building with npm..."
    - npm run build
    - echo "Build complete."
    - echo "Synthesizing CDK..."
    - cdk synth
    - echo "CDK synth complete."

tslint-test-job:   # Runs eslint for typescript to validate linting of typescript code
  stage: static
  image: node:latest
  script:
    - echo "Installing typescript as dependency"
    - npm install typescript@latest -g
    - echo "succesfully installed typescript"
    - echo "Installing python as dependency"
    - npm i python@latest -g
    - echo "succesfully installed python"
    - echo "Installing all package dependencies"
    - npm install -g aws-cdk
    - npm ci
    - echo "succesfully installed package dependencies!"
    - echo "Building with npm..."
    - npm run build
    - echo "Build complete."
    - echo "Linting code... This will take about 10 seconds."
    - npm run lint
    - echo "No lint issues found."

bandit:   # Runs python bandit test job for security checks on python code in repo
  stage: static    # Only starts when job in build stage completes successfully
  image:
    name: python:latest
    entrypoint:
      - "/usr/bin/env"
      - "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  script:
    - ls -la
    - python --version
    - pip3 install --upgrade pip
    - pip3 install --upgrade setuptools
    - pip3 install bandit
    - bandit ./ -r | tee ./output_test.log --format xml $PYTHON_SCRIPTS > bandit.xml
  artifacts:
    when: always
    reports:
      junit: bandit.xml

flake8:
  stage: static
  image: python
  script:
  - apt-get -qy install flake8 python3-pip
  - pip3 install flake8_formatter_junit_xml
  - flake8 --version
  - flake8 --format junit-xml $PYTHON_SCRIPTS > flake8.xml
  artifacts:
    when: always
    reports:
      junit: flake8.xml

mypy:
  stage: static
  image: python
  script:
  - apt-get -qy install mypy
  - mypy --version
  - mypy --scripts-are-modules --junit-xml mypy.xml $PYTHON_SCRIPTS
  artifacts:
    when: always
    reports:
      junit: mypy.xml

pylint:
  stage: static
  image: debian:bullseye
  script:
  - 'apt-get -qy install
       pylint
       python3-dns
       python3-geoip
       python3-pip
       python3-junit.xml'
  - pip3 install pylint_junit
  - pylint --version
  - 'pylint --output-format=pylint_junit.JUnitReporter $PYTHON_SCRIPTS
       > pylint.xml'
  artifacts:
    when: always
    reports:
      junit: pylint.xml

cdk-nag-job:   # runs cdk-nag script in test stage
  stage: static
  script:
    - echo " Running security validation checks on code... This will take about 10 seconds."
    - sleep 10
    - echo "No issues found!"

taskcat-deploy-job:      # Runs taskcat deployment job in test AWS account
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  script:
    - echo "Simulating application deployment..."
    - echo "Application deployment placeholder passed"
